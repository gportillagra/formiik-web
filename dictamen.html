<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador Excel - Contactos Formiik</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css">
    <script type="module" src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="config.js" defer></script>
    <style>
        .date-input-group {
            position: relative;
            width: 160px;
        }
        .date-input-group i {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            z-index: 4;
            pointer-events: none;
        }
        .date-input-group input {
            padding-right: 35px;
        }
    </style>
</head>
<body>
    <div class="page">
        <!-- Sidebar -->
        <aside class="navbar navbar-vertical navbar-expand-lg navbar-dark">
            <div class="container-fluid">
                <div class="navbar-brand-wrapper">
                    <a href="#" class="navbar-brand logo logo-lg" aria-label="Home">
                        <strong class="navbar-brand-regular">Formiik</strong>
                        <strong class="navbar-brand-collapsed">F</strong>
                    </a>
                </div>
            </div>
        </aside>

        <div class="page-wrapper">
            <!-- Header -->
            <div class="page-header d-print-none">
                <div class="container-fluid">
                    <div class="row g-2 align-items-center">
                        <div class="col">
                            <h2 class="page-title mb-1">Contactos con Dictamen</h2>
                            <div class="page-pretitle">
                                Exporta a Excel contactos filtrados por dictamen y fecha
                            </div>
                        </div>
                        <div class="col-auto ms-sm-auto">
                            <div class="btn-list">
                                <div class="date-input-group me-2">
                                    <i class="ti ti-calendar-event"></i>
                                    <input type="date" id="fechaFilter" class="form-control form-control-sm" 
                                           placeholder="Desde fecha dictamen">
                                </div>
                                <button id="loadBtn" class="btn btn-primary">
                                    <i class="ti ti-database-import me-2"></i>Cargar Datos
                                </button>
                                <button id="generateBtn" class="btn btn-success" disabled>
                                    <i class="ti ti-file-spreadsheet me-2"></i>Generar Excel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content -->
            <div class="page-body">
                <div class="container-fluid">
                    <!-- Stats Cards -->
                    <div class="row row-cards row-deck">
                        <div class="col-md-3 col-sm-6">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <span class="avatar bg-blue avatar-rounded-start">
                                            <i class="ti ti-users fs-4"></i>
                                        </span>
                                        <div class="ms-3">
                                            <h3 id="totalCount" class="mb-0 lh-1 fs-3">0</h3>
                                            <small class="text-muted">Contactos cargados</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <span class="avatar bg-green avatar-rounded-start">
                                            <i class="ti ti-checks fs-4"></i>
                                        </span>
                                        <div class="ms-3">
                                            <h3 id="successCount" class="mb-0 lh-1 fs-3">0</h3>
                                            <small class="text-muted">Listos para exportar</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Card -->
                    <div class="row row-cards">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <i class="ti ti-table me-2"></i>Lista de Contactos
                                    </h3>
                                </div>
                                <div class="card-body border-bottom py-1">
                                    <div class="d-flex">
                                        <div id="status" class="flex-fill"></div>
                                        <div class="btn-list ms-auto">
                                            <span id="recordsInfo" class="badge bg-azure text-xs">0 registros</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table card-table table-vcenter table-hover datatable">
                                        <thead class="table-dark">
                                            <tr>
                                                <th class="w-1">Contrato</th>
                                                <th class="w-1">Asignaci√≥n</th>
                                                <th class="w-2">Nombre</th>
                                                <th>Dictamen</th>
                                                <th class="w-1">Fecha</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tableBody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Backdrop -->
    <div class="backdrop" hidden></div>

    <script>
        let db;
        let contactosData = [];

        async function initFirebase(config) {
            try {
                firebase.initializeApp(config);
                db = firebase.firestore();
                showStatus('Firebase conectado correctamente', 'success');
                document.getElementById('loadBtn').disabled = false;
            } catch (error) {
                showStatus('Error conectando Firebase: ' + error.message, 'danger');
                console.error(error);
            }
        }

        async function loadData() {
            document.getElementById('loadBtn').disabled = true;
            const fechaFilter = document.getElementById('fechaFilter').value;
            showStatus('Conectando a Firestore y cargando contactos...', 'info');
            
            try {
                // ‚úÖ Query base
                let query = db.collection('contactos')
                    .where('dictamen', '!=', 'UNSPECIFIED');
                
                // ‚úÖ Filtro Timestamp aplicado directamente al query
                if (fechaFilter) {
                    const fechaInicio = new Date(fechaFilter + 'T00:00:00.000Z');
                    query = query.where('fechaDictamen', '>=', firebase.firestore.Timestamp.fromDate(fechaInicio));
                    showStatus(`üîç Filtrando desde ${fechaFilter}`, 'info');
                }
                
                const snapshot = await query.get();
                
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = '';
                contactosData = [];
                
                if (snapshot.empty) {
                    const msg = fechaFilter ? `No hay contactos desde ${fechaFilter}` : 'No se encontraron contactos con dictamen';
                    showStatus(msg, 'warning');
                    updateStats(0, 0);
                    return;
                }

                snapshot.forEach(doc => {
                    const contacto = doc.data();
                    const fechaStr = contacto.fechaDictamen ? contacto.fechaDictamen.toDate().toLocaleDateString('es-MX') : '';
                    
                    const row = tbody.insertRow();
                    const cells = [
                        contacto.noContrato || '',
                        contacto.idAsignacion || '',
                        contacto.nombre || '',
                        contacto.dictamen || '',
                        fechaStr
                    ];
                    
                    cells.forEach((text, i) => {
                        const cell = row.insertCell(i);
                        cell.textContent = text;
                        cell.className = 'text-truncate';
                    });
                    
                    contactosData.push({
                        noContrato: contacto.noContrato || '',
                        idAsignacion: contacto.idAsignacion || '',
                        nombre: contacto.nombre || '',
                        dictamen: contacto.dictamen || '',
                        fechaDictamen: fechaStr
                    });
                });
                
                updateStats(contactosData.length, contactosData.length);
                const filtroMsg = fechaFilter ? `desde ${fechaFilter}` : 'todos';
                showStatus(`‚úÖ Cargados ${contactosData.length} contactos (${filtroMsg})`, 'success');
                document.getElementById('generateBtn').disabled = false;
                
            } catch (error) {
                showStatus('‚ùå Error al cargar datos: ' + error.message, 'danger');
                console.error(error);
            } finally {
                document.getElementById('loadBtn').disabled = false;
            }
        }

        function updateStats(total, success) {
            document.getElementById('totalCount').textContent = total;
            document.getElementById('successCount').textContent = success;
            document.getElementById('recordsInfo').textContent = `${total} registros`;
            document.getElementById('recordsInfo').className = total > 0 ? 'badge bg-success text-xs' : 'badge bg-muted text-xs';
        }

        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            const icon = type === 'success' ? '‚úÖ' : type === 'danger' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚è≥';
            status.innerHTML = `<div class="alert alert-${type} alert-dismissible alert-small" role="alert">
                <span>${icon} ${message}</span>
            </div>`;
        }

        function exportToExcel() {
            if (contactosData.length === 0) {
                showStatus('No hay datos para exportar', 'warning');
                return;
            }

            // Crear hoja con formato profesional
            const ws = XLSX.utils.json_to_sheet(contactosData);
            
            // ‚úÖ Estilo encabezados (fila 0)
            const range = XLSX.utils.decode_range(ws['!ref']);
            for(let C = range.s.c; C <= range.e.c; ++C) {
                const cell_address = XLSX.utils.encode_cell({c:C,r:0});
                if(!ws[cell_address]) continue;
                ws[cell_address].s = {
                    font: { bold: true, color: { rgb: "FFFFFF" } },
                    fill: { fgColor: { rgb: "4472C4" } },
                    alignment: { horizontal: "center", vertical: "center", wrapText: true }
                };
            }
            
            // ‚úÖ Autoajustar ancho columnas
            const colWidths = [];
            const headers = Object.keys(contactosData[0] || {});
            headers.forEach((header, i) => {
                let maxLength = header.length;
                contactosData.forEach(row => {
                    const value = row[header]?.toString() || '';
                    maxLength = Math.max(maxLength, value.length);
                });
                colWidths[i] = { wch: Math.min(Math.max(maxLength + 2, 12), 50) };
            });
            ws['!cols'] = colWidths;
            
            // ‚úÖ Bordes y formato filas
            for(let R = range.s.r + 1; R <= range.e.r; ++R) {
                for(let C = range.s.c; C <= range.e.c; ++C) {
                    const cell_address = XLSX.utils.encode_cell({c:C,r:R});
                    if(!ws[cell_address]) continue;
                    if(!ws[cell_address].s) ws[cell_address].s = {};
                    ws[cell_address].s = {
                        border: {
                            top: { style: 'thin', color: { rgb: "DDDDDD" } },
                            bottom: { style: 'thin', color: { rgb: "DDDDDD" } },
                            left: { style: 'thin', color: { rgb: "DDDDDD" } },
                            right: { style: 'thin', color: { rgb: "DDDDDD" } }
                        },
                        alignment: { horizontal: "left", vertical: "center", wrapText: true }
                    };
                    // Alternar color filas
                    if (R % 2 === 1) {
                        ws[cell_address].s.fill = { fgColor: { rgb: "F2F2F2" } };
                    }
                }
            }
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Dictamen_cuentas');
            
            const fechaFilter = document.getElementById('fechaFilter').value;
            const filename = `dictamen_cuentas_xalapa_${fechaFilter || 'todos'}_${new Date().toISOString().split('T')[0]}.xlsx`;
            
            XLSX.writeFile(wb, filename);
            showStatus(`üìä Excel descargado (${contactosData.length} registros)`, 'success');
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('loadBtn').addEventListener('click', loadData);
            document.getElementById('generateBtn').addEventListener('click', exportToExcel);
            
            // Load config and init
            if (typeof firebaseConfig !== 'undefined') {
                initFirebase(firebaseConfig);
            }
        });
    </script>
</body>
</html>