<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor equipos recuperados - Formiik</title>
    <!-- ✅ Tabler Icons (necesario para ti-check/ti-x) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css">
    <!-- Tabler CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler.min.css" />
    <style>
        .filters-section {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .filter-group { margin-bottom: 1rem; }
        .filter-label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #374151;
        }
        #btnFilter { width: 100%; margin-top: 1rem; }
        .devices-table {
            background: white;
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .table-responsive { margin-bottom: 0; }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .status-select {
            padding: 0.25rem 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            background: white;
            min-width: 90px;
        }
        .status-abierta { background: #fef3c7; color: #92400e; }
        .status-revision { background: #dbeafe; color: #1e40af; }
        .status-autorizado { background: #dcfce7; color: #166534; }
        .status-rechazado { background: #fee2e2; color: #991b1b; }
        .status-pagado { background: #dcfce7; color: #166534; }
        .loading { text-align: center; padding: 2rem; }
        .no-results { text-align: center; padding: 2rem; color: #6b7280; }
        .print-section { display: none; margin-top: 1rem; }
        .progress-container {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .progress-container.active { display: block; }
        .progress-bar { height: 25px; border-radius: 0.5rem; overflow: hidden; }
        .progress-text {
            text-align: center;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
        }
        .saving-indicator {
            font-size: 0.7rem;
            color: #10b981;
            margin-left: 0.25rem;
        }
        .saving-error {
            color: #ef4444;
        }
    </style>
</head>
<body>
    <div class="page">
        <div class="page-wrapper">
            <div class="page-header d-print-none">
                <div class="container-xl">
                    <div class="row g-2 align-items-center">
                        <div class="col">
                            <h2 class="page-title mb-0">Visor de equipos recuperados</h2>
                        </div>
                    </div>
                </div>
            </div>
            <div class="page-body">
                <div class="container-xl">
                    <!-- Filtros -->
                    <div class="filters-section">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="filter-group">
                                    <label class="filter-label">Seleccionar Gestor (Usuario)</label>
                                    <select id="selectGestor" class="form-select">
                                        <option value="">Cargando usuarios...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="filter-group">
                                    <label class="filter-label">Seleccionar Prealerta</label>
                                    <select id="selectPrealerta" class="form-select" disabled>
                                        <option value="">Primero selecciona un gestor</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <button id="btnFilter" class="btn btn-primary" disabled>
                            <i class="ti ti-filter me-2"></i> Filtrar equipos
                        </button>
                    </div>

                    <!-- Tabla de resultados -->
                    <div class="devices-table">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <div id="loading" class="loading" style="display: none;">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                    <p class="mt-2">Cargando equipos...</p>
                                </div>
                                <table class="table table-vcenter card-table">
                                    <thead class="table-light">
                                        <tr>
                                            <th>#</th>
                                            <th>Contrato</th>
                                            <th>Nombre</th>
                                            <th>Tipo</th>
                                            <th>Serie</th>
                                            <th>Status</th>
                                            <th>Fecha Recup.</th>
                                            <th>Fuente</th>
                                            <th>Control</th>
                                        </tr>
                                    </thead>
                                    <tbody id="devicesTableBody"></tbody>
                                </table>
                                <div id="noResults" class="no-results" style="display: none;">
                                    Selecciona gestor y prealerta para ver los equipos recuperados
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Barra de progreso -->
                    <div id="progressContainer" class="progress-container">
                        <div class="progress progress-bar">
                            <div id="progressBar" class="progress-bar bg-success" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="progress-text">
                            <span id="progressText">0%</span> - <span id="progressStatus">Iniciando...</span>
                        </div>
                    </div>

                    <!-- Botón PDF -->
                    <div id="printSection" class="print-section">
                        <button id="btnGeneratePDF" class="btn btn-success btn-lg" style="width: 100%;" disabled>
                            <i class="ti ti-file-pdf me-2"></i> Generar PDF con Todas las Imágenes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Librerías PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Firebase SDK v10 compat -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    
    <!-- Tabler JS -->
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/js/tabler.min.js"></script>
    
    <script src="config.js"></script>
    
    <script>
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const statusMap = {
            'ABIERTA': 'status-abierta',
            'EDICION': 'status-abierta',
            'REVISION': 'status-revision',
            'AUTORIZADO': 'status-autorizado',
            'RECHAZADO': 'status-rechazado',
            'PAGADO': 'status-pagado'
        };

        const statusOptions = [
            { value: 'ABIERTA', label: 'ABIERTA', class: 'status-abierta' },
            { value: 'EDICION', label: 'EDICIÓN', class: 'status-abierta' },
            { value: 'REVISION', label: 'REVISIÓN', class: 'status-revision' },
            { value: 'AUTORIZADO', label: 'AUTORIZADO', class: 'status-autorizado' },
            { value: 'RECHAZADO', label: 'RECHAZADO', class: 'status-rechazado' },
            { value: 'PAGADO', label: 'PAGADO', class: 'status-pagado' }
        ];

        let currentDevices = [];
        let unsubscribeDevices = null; // Para limpiar escucha en tiempo real

        async function imageUrlToBase64(imageUrl, maxWidth = 800, quality = 0.7) {
            try {
                const response = await fetch(imageUrl);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const blob = await response.blob();
                
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.src = URL.createObjectURL(blob);
                    
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
                        resolve(compressedBase64);
                    };
                    
                    img.onerror = reject;
                });
            } catch (error) {
                console.error('Error procesando imagen:', error);
                return null;
            }
        }

        async function loadUsers() {
            try {
                const snapshot = await db.collection('usuarios').get();
                const selectGestor = document.getElementById('selectGestor');
                selectGestor.innerHTML = '<option value="">Selecciona un gestor</option>';
                snapshot.forEach(doc => {
                    const user = doc.data();
                    const option = document.createElement('option');
                    option.value = user.email;
                    option.textContent = user.displayName || user.email || 'Sin nombre';
                    selectGestor.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        function resetStateBeforeFilter() {
            currentDevices = [];
            document.getElementById('devicesTableBody').innerHTML = '';
            document.getElementById('noResults').style.display = 'none';
            document.getElementById('loading').style.display = 'none';
            document.getElementById('printSection').style.display = 'none';
            document.getElementById('btnGeneratePDF').disabled = true;

            // ✅ Detener escucha en tiempo real anterior
            if (unsubscribeDevices) {
                unsubscribeDevices();
                unsubscribeDevices = null;
            }

            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const progressStatus = document.getElementById('progressStatus');

            progressContainer.classList.remove('active');
            progressBar.style.width = '0%';
            progressBar.setAttribute('aria-valuenow', '0');
            progressText.textContent = '0%';
            progressStatus.textContent = 'Iniciando...';
        }

        // ✅ Función para actualizar status en Firestore
        async function updateDeviceStatus(deviceId, newStatus) {
            try {
                const statusCell = document.querySelector(`[data-device-id="${deviceId}"] .status-saving-indicator`);
                if (statusCell) {
                    statusCell.textContent = 'Guardando...';
                    statusCell.className = 'saving-indicator';
                }

                await db.collection('dispositivos').doc(deviceId).update({
                    status: newStatus
                });

                // ✅ Actualizar localmente para respuesta inmediata
                const deviceIndex = currentDevices.findIndex(d => d.id === deviceId);
                if (deviceIndex !== -1) {
                    currentDevices[deviceIndex].data.status = newStatus;
                }

                if (statusCell) {
                    statusCell.textContent = 'Guardado ✓';
                    setTimeout(() => {
                        statusCell.remove();
                    }, 2000);
                }
            } catch (error) {
                console.error('Error updating status:', error);
                if (statusCell) {
                    statusCell.textContent = 'Error';
                    statusCell.className = 'saving-indicator saving-error';
                }
            }
        }

        document.getElementById('selectGestor').addEventListener('change', async function() {
            const gestorEmail = this.value;
            const selectPrealerta = document.getElementById('selectPrealerta');
            const btnFilter = document.getElementById('btnFilter');

            resetStateBeforeFilter();

            selectPrealerta.innerHTML = '<option value="">Cargando prealertas...</option>';
            selectPrealerta.disabled = true;
            btnFilter.disabled = true;
            if (!gestorEmail) return;
            try {
                const snapshot = await db.collection('prealerta')
                    .where('gestor', 'array-contains', gestorEmail)
                    .get();

                selectPrealerta.innerHTML = '<option value="">Selecciona una prealerta</option>';
                if (snapshot.empty) {
                    selectPrealerta.innerHTML = '<option value="">No hay prealertas</option>';
                    selectPrealerta.disabled = false;
                    return;
                }
                snapshot.forEach(doc => {
                    const prealerta = doc.data();
                    const option = document.createElement('option');
                    const semana = prealerta.noSemana || 'N/C';
                    const status = prealerta.status || 'ABIERTA';
                    const fechaEntrada = prealerta.fechaEntradaAlmacen
                        ? new Date(prealerta.fechaEntradaAlmacen).toLocaleDateString('es-MX')
                        : 'Sin fecha';
                    option.value = doc.id;
                    option.textContent = `Semana ${semana} - ${status}`;
                    selectPrealerta.appendChild(option);
                });
                selectPrealerta.disabled = false;
            } catch (error) {
                console.error('Error loading prealertas:', error);
            }
        });

        document.getElementById('selectPrealerta').addEventListener('change', function() {
            document.getElementById('btnFilter').disabled = !this.value;
            resetStateBeforeFilter();
        });

        // ✅ ✅ CAMBIO PRINCIPAL: Reemplaza get() por onSnapshot()
        document.getElementById('btnFilter').addEventListener('click', async function() {
            const prealertaId = document.getElementById('selectPrealerta').value;
            if (!prealertaId) return;

            resetStateBeforeFilter();
            document.getElementById('loading').style.display = 'block';

            try {
                // ✅ Escucha en tiempo real en lugar de get()
                unsubscribeDevices = db.collection('dispositivos')
                    .where('idPrealerta', '==', prealertaId)
                    .where('urlFoto', '!=', null)
                    .orderBy('fechaRecuperado')
                    .onSnapshot((snapshot) => {
                        currentDevices = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
                        displayDevicesTable(currentDevices);
                        
                        if (currentDevices.length > 0) {
                            document.getElementById('btnGeneratePDF').disabled = false;
                        }
                    }, (error) => {
                        console.error('Error en escucha dispositivos:', error);
                        document.getElementById('loading').style.display = 'none';
                    });

                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                console.error('Error starting listener:', error);
                document.getElementById('loading').style.display = 'none';
            }
        });

        function displayDevicesTable(devices) {
            const tbody = document.getElementById('devicesTableBody');
            const loading = document.getElementById('loading');
            const noResults = document.getElementById('noResults');
            tbody.innerHTML = '';

            if (devices.length === 0) {
                loading.style.display = 'none';
                noResults.style.display = 'block';
                return;
            }

            devices.forEach((device, index) => {
                const data = device.data;
                let fechaRecup = 'N/A';
                if (data.fechaRecuperado) {
                    const fecha = new Date(data.fechaRecuperado);
                    fechaRecup = fecha.toLocaleDateString('es-MX');
                }
                const tieneFuente = data.fuenteAlimentacion === true;
                const tieneControl = data.controlRemoto === true;

                // ✅ Status como SELECT editable
                const statusSelect = statusOptions.map(option => 
                    `<option value="${option.value}" ${data.status === option.value ? 'selected' : ''}>
                        ${option.label}
                    </option>`
                ).join('');

                const row = `
                    <tr data-device-id="${device.id}">
                        <td>${index + 1}</td>
                        <td><strong>${data.noContrato || 'N/C'}</strong></td>
                        <td>${data.nombre || 'Sin nombre'}</td>
                        <td>${data.tipoDispositivo || 'N/C'}</td>
                        <td>${data.noSerie || 'N/C'}</td>
                        <td>
                            <select class="status-select" onchange="updateDeviceStatus('${device.id}', this.value)">
                                ${statusSelect}
                            </select>
                            <span class="saving-indicator" style="display: none;"></span>
                        </td>
                        <td>${fechaRecup}</td>
                        <td><i class="ti ${tieneFuente ? 'ti-check text-success' : 'ti-x text-danger'}"></i></td>
                        <td><i class="ti ${tieneControl ? 'ti-check text-success' : 'ti-x text-danger'}"></i></td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            loading.style.display = 'none';
            document.getElementById('noResults').style.display = 'none';
            document.getElementById('printSection').style.display = 'block';
        }

        // ✅ Resto del código PDF sin cambios (imageUrlToBase64, btnGeneratePDF, etc.)
        document.getElementById('btnGeneratePDF').addEventListener('click', async function() {
            if (currentDevices.length === 0) return;
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'p',
                unit: 'mm',
                format: 'a4',
                compress: true
            });
            
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const progressStatus = document.getElementById('progressStatus');
            
            progressContainer.classList.add('active');
            document.getElementById('btnGeneratePDF').disabled = true;

            const pageHeight = pdf.internal.pageSize.getHeight();
            const pageWidth = pdf.internal.pageSize.getWidth();
            const totalDevices = currentDevices.length;

            try {
                for (let i = 0; i < totalDevices; i++) {
                    const device = currentDevices[i];
                    const data = device.data;

                    if (i > 0) {
                        pdf.addPage();
                    }

                    const progress = Math.round(((i + 1) / totalDevices) * 100);
                    progressBar.style.width = progress + '%';
                    progressBar.setAttribute('aria-valuenow', progress.toString());
                    progressText.textContent = progress + '%';
                    progressStatus.textContent = `Procesando ${data.noContrato || 'dispositivo'}...`;

                    const marginX = 15;
                    let y = 15;

                    pdf.setFontSize(14);
                    pdf.setTextColor(31, 41, 55);
                    pdf.text(`${data.noContrato || 'N/C'} - ${data.nombre || 'Sin nombre'}`, marginX, y);
                    y += 8;

                    pdf.setFontSize(10);
                    pdf.setTextColor(55, 65, 81);

                    let fechaRecupText = 'Fecha recup.: N/A';
                    if (data.fechaRecuperado) {
                        const fecha = new Date(data.fechaRecuperado).toLocaleDateString('es-MX');
                        fechaRecupText = `Fecha recup.: ${fecha}`;
                    }

                    const idAsignacionText = `No. serie: ${data.noSerie || 'N/C'}`;
                    const fuenteText = `Fuente: ${data.fuenteAlimentacion ? 'Sí' : 'No'}`;
                    const controlText = `Control: ${data.controlRemoto ? 'Sí' : 'No'}`;

                    pdf.setTextColor(75, 85, 99);
                    pdf.text(fechaRecupText, marginX, y);
                    y += 5;

                    pdf.text(idAsignacionText, marginX, y);
                    y += 5;

                    const colorFuente = data.fuenteAlimentacion ? [22, 101, 52] : [153, 27, 27];
                    const colorControl = data.controlRemoto ? [22, 101, 52] : [153, 27, 27];

                    pdf.setTextColor(colorFuente[0], colorFuente[1], colorFuente[2]);
                    pdf.text(fuenteText, marginX, y);

                    const controlX = marginX + 50;
                    pdf.setTextColor(colorControl[0], colorControl[1], colorControl[2]);
                    pdf.text(controlText, controlX, y);

                    y += 10;

                    pdf.setDrawColor(209, 213, 219);
                    pdf.setLineWidth(0.2);
                    pdf.line(marginX, y, pageWidth - marginX, y);
                    y += 5;

                    if (data.urlFoto) {
                        const imageBase64 = await imageUrlToBase64(data.urlFoto);

                        if (imageBase64) {
                            const img = new Image();
                            img.src = imageBase64;

                            await new Promise((resolveImg) => {
                                img.onload = () => {
                                    const imgWidthPx = img.width;
                                    const imgHeightPx = img.height;
                                    const ratio = imgWidthPx / imgHeightPx;
                                    const maxWidth = pageWidth - marginX * 2;
                                    const maxHeight = pageHeight - y - 15;

                                    let drawWidth = maxWidth;
                                    let drawHeight = drawWidth / ratio;

                                    if (drawHeight > maxHeight) {
                                        drawHeight = maxHeight;
                                        drawWidth = drawHeight * ratio;
                                    }

                                    const xCentered = marginX + (maxWidth - drawWidth) / 2;
                                    pdf.addImage(imageBase64, 'JPEG', xCentered, y, drawWidth, drawHeight);
                                    resolveImg();
                                };
                                img.onerror = () => {
                                    pdf.setFontSize(9);
                                    pdf.setTextColor(200, 0, 0);
                                    pdf.text('Imagen no disponible', marginX, y + 5);
                                    resolveImg();
                                };
                            });
                        } else {
                            pdf.setFontSize(9);
                            pdf.setTextColor(200, 0, 0);
                            pdf.text('Imagen no disponible', marginX, y + 5);
                        }
                    } else {
                        pdf.setFontSize(9);
                        pdf.setTextColor(200, 0, 0);
                        pdf.text('Sin imagen asociada', marginX, y + 5);
                    }
                }

                progressStatus.textContent = '¡PDF generado exitosamente!';
                const prealertaId = document.getElementById('selectPrealerta').value;
                pdf.save(`Evidencia_equipos_recuperados_${prealertaId}.pdf`);

                setTimeout(() => {
                    const progressContainer = document.getElementById('progressContainer');
                    progressContainer.classList.remove('active');
                    document.getElementById('btnGeneratePDF').disabled = false;
                    document.getElementById('progressBar').style.width = '0%';
                    document.getElementById('progressBar').setAttribute('aria-valuenow', '0');
                    document.getElementById('progressText').textContent = '0%';
                    document.getElementById('progressStatus').textContent = 'Iniciando...';
                }, 2000);

            } catch (error) {
                console.error('Error PDF:', error);
                progressStatus.textContent = 'Error generando PDF';
                document.getElementById('btnGeneratePDF').disabled = false;
            }
        });

        document.addEventListener('DOMContentLoaded', async function() {
            await loadUsers();
        });
    </script>
</body>
</html>