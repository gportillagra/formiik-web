<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Actualizar colección /telefonos</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
    <script src="config.js"></script>
    <style>
        body { background: #f5f7fb; }
        .page { display: flex; min-height: 100vh; align-items: center; justify-content: center; }
        .card { max-width: 700px; width: 100%; }
        .log-box {
            background: #0b1020;
            color: #e5e7eb;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 12px;
            padding: 0.75rem;
            border-radius: 0.5rem;
            max-height: 260px;
            overflow-y: auto;
        }
        .log-box span.ok { color: #4ade80; }
        .log-box span.err { color: #f97373; }
        .log-box span.info { color: #60a5fa; }
    </style>
</head>
<body>
<div class="page">
    <div class="container-xl">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-md-10">
                <div class="card card-md">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="ti ti-phone-check me-2"></i>
                            Completar datos en colección /telefonos
                        </h3>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">
                            Este script recorrerá todos los documentos de <code>/telefonos</code>, usará el campo 
                            <code>noContrato</code> para leer el documento correspondiente en <code>/contactos</code> y 
                            actualizará los campos faltantes (nombre, calle, colonia, código postal, ciudad, estado, esArchivado).
                        </p>

                        <div class="row mb-3">
                            <div class="col-6">
                                <div class="mb-2">Total teléfonos:</div>
                                <h3 id="totalTelefonos">0</h3>
                            </div>
                            <div class="col-6">
                                <div class="mb-2">Actualizados:</div>
                                <h3 id="totalActualizados">0</h3>
                            </div>
                        </div>

                        <div class="mb-3">
                            <button id="btnTest" class="btn btn-outline-primary me-2">
                                <i class="ti ti-plug-connected me-2"></i>Probar conexión
                            </button>
                            <button id="btnRun" class="btn btn-primary">
                                <i class="ti ti-database-import me-2"></i>Ejecutar actualización
                            </button>
                            <button id="btnDryRun" class="btn btn-outline-secondary ms-2">
                                <i class="ti ti-eye me-2"></i>Dry-run (solo vería cambios)
                            </button>
                        </div>

                        <div class="mb-2">
                            <span id="status" class="badge bg-secondary">Esperando acción…</span>
                        </div>

                        <div class="log-box" id="log"></div>

                        <div class="mt-3 small text-muted">
                            Nota: por seguridad, la actualización se hace documento por documento (no batch) para que puedas ver el progreso y errores en tiempo real. [web:41][web:45]
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let db;
    let isRunning = false;

    function log(message, type = 'info') {
        const logBox = document.getElementById('log');
        const span = document.createElement('div');
        span.className = type;
        span.innerHTML = `<span class="${type}">[${new Date().toLocaleTimeString()}]</span> ${message}`;
        logBox.appendChild(span);
        logBox.scrollTop = logBox.scrollHeight;
    }

    function setStatus(text, color = 'secondary') {
        const badge = document.getElementById('status');
        badge.textContent = text;
        badge.className = `badge bg-${color}`;
    }

    function safeField(obj, key, fallback = '') {
        const value = obj && obj[key];
        if (value === undefined || value === null) return fallback;
        return value;
    }

    function initFirebase() {
        if (db) return;
        if (typeof firebaseConfig === 'undefined') {
            log('firebaseConfig no definido. Verifica config.js', 'err');
            setStatus('Error config Firebase', 'danger');
            return;
        }
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        log('Firebase inicializado correctamente', 'ok');
        setStatus('Firebase listo', 'success');
    }

    async function testConnection() {
        try {
            initFirebase();
            setStatus('Probando conexión…', 'info');
            log('Leyendo 1 documento de /telefonos para prueba…', 'info');
            const snap = await db.collection('telefonos').limit(1).get();
            if (snap.empty) {
                log('Colección /telefonos está vacía', 'warn');
                setStatus('Sin documentos en /telefonos', 'warning');
            } else {
                const doc = snap.docs[0];
                log(`OK: documento de prueba /telefonos/${doc.id}`, 'ok');
                setStatus('Conexión OK', 'success');
            }
        } catch (e) {
            console.error(e);
            log('Error probando conexión: ' + e.message, 'err');
            setStatus('Error conexión', 'danger');
        }
    }

    async function runUpdate({ dryRun = false } = {}) {
        if (isRunning) return;
        isRunning = true;
        initFirebase();

        const totalTelefonosEl = document.getElementById('totalTelefonos');
        const totalActualizadosEl = document.getElementById('totalActualizados');
        totalTelefonosEl.textContent = '0';
        totalActualizadosEl.textContent = '0';
        document.getElementById('log').innerHTML = '';

        try {
            setStatus(dryRun ? 'Dry-run en progreso…' : 'Actualizando teléfonos…', dryRun ? 'warning' : 'info');
            log('Leyendo todos los documentos de /telefonos…', 'info');

            const telSnap = await db.collection('telefonos').get();
            const total = telSnap.size;
            totalTelefonosEl.textContent = total.toString();

            if (telSnap.empty) {
                log('No hay documentos en /telefonos.', 'warn');
                setStatus('Sin documentos para procesar', 'warning');
                isRunning = false;
                return;
            }

            let updatedCount = 0;
            let processed = 0;

            for (const telDoc of telSnap.docs) {
                processed++;
                const telData = telDoc.data();
                const telId = telDoc.id;
                const noContrato = telData.noContrato || '';

                if (!noContrato) {
                    log(`⚠️ /telefonos/${telId} sin noContrato, se omite`, 'warn');
                    continue;
                }

                try {
                    const contactoRef = db.collection('contactos').doc(noContrato);
                    const contactoDoc = await contactoRef.get();

                    if (!contactoDoc.exists) {
                        log(`⚠️ No existe /contactos/${noContrato} para /telefonos/${telId}`, 'warn');
                        continue;
                    }

                    const contacto = contactoDoc.data();

                    const payload = {
                        id: telData.id || telId, // mantener id o setear docId
                        noContrato: noContrato,
                        nombre: safeField(contacto, 'nombre', null),
                        calle: safeField(contacto, 'calle', ''),
                        colonia: safeField(contacto, 'colonia', ''),
                        codigoPostal: safeField(contacto, 'codigoPostal', ''),
                        ciudad: safeField(contacto, 'ciudad', ''),
                        estado: safeField(contacto, 'estado', ''),
                        esArchivado: safeField(contacto, 'esArchivado', false),
                        numero: safeField(telData, 'numero', '')
                    };

                    log(`${dryRun ? '[DRY]' : '[UPD]'} /telefonos/${telId} ← /contactos/${noContrato}`, 'info');
                    log(`    nombre=${payload.nombre} colonia=${payload.colonia} cp=${payload.codigoPostal}`, 'info');

                    if (!dryRun) {
                        await telDoc.ref.update(payload); // update parcial [web:41][web:42]
                    }

                    updatedCount++;
                    totalActualizadosEl.textContent = updatedCount.toString();
                } catch (eDoc) {
                    log(`❌ Error en /telefonos/${telId}: ${eDoc.message}`, 'err');
                }

                if (processed % 20 === 0) {
                    log(`Progreso: ${processed}/${total} procesados`, 'info');
                }
            }

            if (dryRun) {
                setStatus(`Dry-run terminado. Afectaría ${updatedCount} documentos.`, 'warning');
                log(`Dry-run completado. Se actualizarían ${updatedCount} documentos.`, 'ok');
            } else {
                setStatus(`Actualización terminada. ${updatedCount} documentos actualizados.`, 'success');
                log(`✅ Proceso completado. Total actualizados: ${updatedCount}`, 'ok');
            }
        } catch (e) {
            console.error(e);
            log('Error general en proceso: ' + e.message, 'err');
            setStatus('Error en proceso', 'danger');
        } finally {
            isRunning = false;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('btnTest').addEventListener('click', testConnection);
        document.getElementById('btnRun').addEventListener('click', () => runUpdate({ dryRun: false }));
        document.getElementById('btnDryRun').addEventListener('click', () => runUpdate({ dryRun: true }));
    });
</script>
</body>
</html>