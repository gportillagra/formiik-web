<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Formiik Web - Pro Import</title>
  
  <link href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root {
      --formiik-primary: #6366f1;
      --formiik-bg: #f8fafc;
      --glass: rgba(255, 255, 255, 0.9);
    }
    
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: var(--formiik-bg);
      padding-top: 70px; /* Espacio para la navbar */
    }

    /* --- Navbar Superior --- */
    .navbar {
      position: fixed;
      top: 0;
      width: 100%;
      height: 65px;
      background: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 2rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      z-index: 1000;
    }

    .navbar .logo {
      font-weight: 800;
      font-size: 1.5rem;
      color: var(--formiik-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* --- Mapeador de Columnas --- */
    .mapping-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      background: #f1f5f9;
      padding: 1.5rem;
      border-radius: 12px;
      margin: 1rem 0;
    }

    .mapping-item {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .mapping-item label {
      font-size: 0.8rem;
      font-weight: 600;
      color: #475569;
    }

    /* --- Estilos Generales --- */
    .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
    .glass-card { background: white; padding: 2rem; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 2rem; }
    .btn { padding: 0.8rem 1.5rem; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: 0.3s; }
    .btn-primary { background: var(--formiik-primary); color: white; }
    .hidden { display: none; }
    
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th { background: #f8fafc; padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0; }
    td { padding: 12px; border-bottom: 1px solid #e2e8f0; }
    
    .dist-pill {
      background: #eef2ff;
      border-left: 4px solid var(--formiik-primary);
      padding: 10px;
      margin: 5px 0;
      border-radius: 4px;
    }
  </style>
</head>
<body>

  <nav class="navbar">
    <div class="logo">
      <i class="ti ti-layout-dashboard"></i> Formiik Web
    </div>
    <div id="userProfile" style="font-size: 0.9rem; color: #64748b;">
      Cargando sesión...
    </div>
  </nav>

  <div class="container">
    
    <div class="glass-card">
      <h3>1. Subir Archivo</h3>
      <input type="file" id="excelFile" accept=".xlsx,.xls" class="hidden">
      <button class="btn btn-primary" onclick="document.getElementById('excelFile').click()">
        <i class="ti ti-file-upload"></i> Seleccionar Excel
      </button>

      <div id="mappingSection" class="hidden" style="margin-top: 2rem;">
        <hr>
        <h4><i class="ti ti-map-pin"></i> Vincular Columnas</h4>
        <p>Selecciona qué columna del Excel corresponde a cada dato del sistema:</p>
        <div class="mapping-grid" id="mappingControls">
          </div>
        <button id="processData" class="btn btn-primary">Procesar con este mapeo</button>
      </div>
    </div>

    <div id="resultsSection" class="hidden">
      <div class="glass-card">
        <h3><i class="ti ti-chart-pie"></i> Distribución de Cartera</h3>
        <div id="distributionDetails"></div>
      </div>

      <div class="glass-card">
        <h3><i class="ti ti-list-details"></i> Vista Previa</h3>
        <div style="overflow-x: auto;">
          <table id="previewTable">
            <thead>
              <tr id="tableHeaders"></tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
        <div style="margin-top: 2rem;">
          <button id="saveToFirebase" class="btn btn-primary" style="background: #10b981;">
            <i class="ti ti-cloud-upload"></i> Guardar Todo en Firestore
          </button>
        </div>
      </div>
    </div>

  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getFirestore, collection, doc, setDoc } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';

    // Configuración (Asegúrate de que sea la correcta)
    const firebaseConfig = JSON.parse(atob('eyJhcGlLZXkiOiJBSXphU3lBd01qUnNLbzVwTnRwalVIdklPVGg0LTJqbFMzY1lVVzAiLCJhdXRoRG9tYWluIjoiZm9ybWlpay5maXJlYmFzZWFwcC5jb20iLCJwcm9qZWN0SWQiOiJmb3JtaWlrIiwic3RvcmFnZUJ1Y2tldCI6ImZvcm1paWsuYXBwc3BvdC5jb20iLCJtZXNzYWdpbmdTZW5kZXJJZCI6IjQxNDE2MTY5MzY4OCIsImFwcElkIjoiMTo0MTQxNjE2OTM2ODg6d2ViOmMyYmIwOWM2YWJmNjA0NzYyMjA0MGQiLCJtZWFzdXJlbWVudElkIjoiRy1TR1FMSkoyR0NTIn0='));
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let rawHeaders = [];
    let excelRows = [];
    let finalData = [];

    // Campos requeridos por el sistema
    const requiredFields = [
      { id: 'id', label: 'ID Único (o Contrato)' },
      { id: 'nombre', label: 'Nombre del Cliente' },
      { id: 'segmento', label: 'Segmento/Zona' },
      { id: 'equipos', label: 'Cantidad de Equipos' }
    ];

    onAuthStateChanged(auth, user => {
      document.getElementById('userProfile').textContent = user ? `Sesión: ${user.email}` : "No autenticado";
    });

    // 1. Leer archivo y mostrar mapeador
    document.getElementById('excelFile').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      const data = await file.arrayBuffer();
      const workbook = XLSX.read(data, { type: 'array' });
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

      if (json.length > 0) {
        rawHeaders = json[0]; // Las cabeceras reales del Excel
        excelRows = json.slice(1);
        
        const mappingControls = document.getElementById('mappingControls');
        mappingControls.innerHTML = requiredFields.map(field => `
          <div class="mapping-item">
            <label>${field.label}</label>
            <select id="map_${field.id}" class="btn" style="background: white; border: 1px solid #ccc;">
              <option value="">-- No importar --</option>
              ${rawHeaders.map((h, idx) => `<option value="${idx}">${h}</option>`).join('')}
            </select>
          </div>
        `).join('');
        
        document.getElementById('mappingSection').classList.remove('hidden');
      }
    });

    // 2. Procesar con el mapeo seleccionado
    document.getElementById('processData').addEventListener('click', () => {
      const mapping = {};
      requiredFields.forEach(f => {
        mapping[f.id] = document.getElementById(`map_${f.id}`).value;
      });

      finalData = excelRows.map(row => ({
        id: String(row[mapping.id] || '').replace(/\s+/g, ''), // CORREGIDO: Ya no borra la 'S'
        nombre: row[mapping.nombre] || 'Sin nombre',
        segmento: row[mapping.segmento] || 'General',
        equipos: parseInt(row[mapping.equipos]) || 0,
        gestorAsignado: []
      }));

      renderTable();
      renderDistribution();
      document.getElementById('resultsSection').classList.remove('hidden');
    });

    function renderTable() {
      const head = document.getElementById('tableHeaders');
      head.innerHTML = '<th>ID</th><th>Nombre</th><th>Segmento</th><th>Equipos</th>';
      
      const body = document.getElementById('tableBody');
      body.innerHTML = finalData.slice(0, 10).map(d => `
        <tr>
          <td>${d.id}</td>
          <td>${d.nombre}</td>
          <td>${d.segmento}</td>
          <td>${d.equipos}</td>
        </tr>
      `).join('') + (finalData.length > 10 ? `<tr><td colspan="4">...y ${finalData.length - 10} filas más</td></tr>` : '');
    }

    function renderDistribution() {
      const stats = {};
      finalData.forEach(d => {
        stats[d.segmento] = (stats[d.segmento] || 0) + 1;
      });

      const distDiv = document.getElementById('distributionDetails');
      distDiv.innerHTML = Object.entries(stats).map(([seg, count]) => `
        <div class="dist-pill">
          <strong>${seg}:</strong> ${count} contactos cargados.
        </div>
      `).join('');
    }

    // 3. Guardado Masivo
    document.getElementById('saveToFirebase').addEventListener('click', async () => {
      const btn = document.getElementById('saveToFirebase');
      btn.disabled = true;
      btn.textContent = "Guardando...";

      try {
        for (let i = 0; i < finalData.length; i += 500) {
          const chunk = finalData.slice(i, i + 500);
          await Promise.all(chunk.map(item => 
            setDoc(doc(db, 'debug_contactos', item.id), item, { merge: true })
          ));
        }
        alert("¡Todo guardado correctamente en Firestore!");
      } catch (error) {
        console.error(error);
        alert("Error al guardar: " + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = "Guardar Todo en Firestore";
      }
    });
  </script>
</body>
</html>
