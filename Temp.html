<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Generar vCard – mapa de teléfonos</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 900px; margin: 2rem auto; padding: 1rem; }
    button { padding: 1rem 2rem; font-size: 1.1rem; cursor: pointer; }
    #status { margin: 1.5rem 0; color: #444; min-height: 1.5rem; }
    #result { white-space: pre-wrap; font-family: monospace; background: #f8f8f8; padding: 1rem; border: 1px solid #ddd; max-height: 400px; overflow: auto; display: none; }
  </style>
</head>
<body>

<h1>Generar vCard (.vcf) – versión con mapa de teléfonos</h1>
<p>Filtra contactos: <code>esArchivado == false</code> + <code>gestorAsignado</code> contiene <code>gportillagra.cp@gmail.com</code></p>

<button id="btnGenerar">Generar archivo vCard ahora</button>

<div id="status">Esperando acción...</div>
<pre id="result"></pre>

<script type="module">
  import { firebaseConfigModule } from "./config.js";
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
  const app = initializeApp(firebaseConfigModule);
  const db = getFirestore(app);

  // ─── Generador vCard ────────────────────────────────────────
  function crearVCard(nombre, telefonos) {
    const nombreLimpio = (nombre || "Sin nombre").replace(/[,;]/g, " ").trim();

    let lines = [
      "BEGIN:VCARD",
      "VERSION:3.0",
      `FN:${nombreLimpio}`,
      `N:${nombreLimpio};;;`,
      "ORG:TotalPlay",
      "CATEGORIES:TotalPlay",
    ];

    telefonos.forEach(tel => {
      // Puedes cambiar TYPE=CELL por WORK, HOME, etc. según necesites
      lines.push(`TEL;TYPE=CELL:${tel}`);
    });

    lines.push("END:VCARD", "");
    return lines.join("\r\n");
  }

  // ─── Lógica principal ───────────────────────────────────────
  document.getElementById("btnGenerar").addEventListener("click", async () => {
    const status = document.getElementById("status");
    const resultPre = document.getElementById("result");

    status.textContent = "Descargando TODA la colección /teléfonos...";
    resultPre.style.display = "none";

    try {
      // 1. Cargar TODOS los teléfonos (una sola consulta)
      const snapshotTels = await getDocs(collection(db, "telefonos"));
      const mapaTelefonos = new Map(); // noContrato → [tel1, tel2, ...]

      snapshotTels.forEach(doc => {
        const data = doc.data();
        const noContrato = data.noContrato;
        const numero = String(data.numero || "").trim();

        if (!noContrato || !numero) return;

        if (!mapaTelefonos.has(noContrato)) {
          mapaTelefonos.set(noContrato, []);
        }
        mapaTelefonos.get(noContrato).push(numero);
      });

      status.textContent = `Cargados ${snapshotTels.size} documentos de teléfonos. Ahora filtrando contactos...`;

      // 2. Obtener solo los contactos que nos interesan
      const qContactos = query(
        collection(db, "contactos"),
        // where("esArchivado", "==", false),
        where("gestorAsignado", "array-contains", "gportillagra.cp@gmail.com")
      );

      const snapshotContactos = await getDocs(qContactos);
      if (snapshotContactos.empty) {
        status.textContent = "No se encontraron contactos activos asignados a ti.";
        return;
      }

      let vcfContent = "";
      let contactosConTelefono = 0;

      // 3. Para cada contacto → buscar en el mapa
      snapshotContactos.forEach(doc => {
        const data = doc.data();
        const nombre = data.nombre || "";
        const noContrato = data.noContrato;

        if (!noContrato) return;

        const telefonos = mapaTelefonos.get(noContrato) || [];
        if (telefonos.length === 0) return;

        vcfContent += crearVCard(nombre, telefonos);
        contactosConTelefono++;
      });

      if (contactosConTelefono === 0) {
        status.textContent = "Se encontraron contactos, pero ninguno tiene teléfonos asociados.";
        return;
      }

      status.textContent = `Generados ${contactosConTelefono} contactos con teléfono(s). Descargando...`;

      // 4. Descargar
      const blob = new Blob([vcfContent], { type: "text/vcard;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "contactos_activos_gportillagra_2025.vcf";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      // Preview opcional
      resultPre.textContent = vcfContent;
      resultPre.style.display = "block";

    } catch (err) {
      console.error(err);
      status.textContent = `Error: ${err.message || "desconocido"}`;
      status.style.color = "crimson";
    }
  });
</script>

</body>
</html>